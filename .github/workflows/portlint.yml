name: Run portlint

on:
  workflow_call:
    inputs:
      freebsd_ports_ref:
        description: A ref of FreeBSD ports
        default: main
        required: false
        type: string

jobs:
  portlint:
    runs-on: ubuntu-latest
    name: Run portlint
    steps:
    - uses: actions/checkout@v4
    - name: Run portlint on FreeBSD
      id: test
      uses: vmactions/freebsd-vm@v1
      with:
        usesh: true
        sync: rsync
        copyback: false
        prepare: |
          # Install requried packages
          pkg install -y ports-mgmt/poudriere-devel devel/git sysutils/tree ports-mgmt/portlint
          echo "pwd: `pwd`"
          tree -d .

          # minimum configuration for poudriere
          printf "# Automatically generated by a GitHub actions workflow.
          NO_ZFS=yes
          RESOLV_CONF=/etc/resolv.conf
          USE_PORTLINT=no
          DISTFILES_CACHE=/home/runner/work/distfiles
          CCACHE_DIR=/home/runner/work/ccache
          SVN_HOST=svn.FreeBSD.org
          GIT_PORTSURL=github.com/freebsd/freebsd-ports.git
          BASEFS=/home/runner/work/poudriere
          " >> /usr/local/etc/poudriere.conf
          echo "The contents of /usr/local/etc/poudriere.conf"
          cat /usr/local/etc/poudriere.conf

          poudriere ports -c -p default -m git+https -B "${{ inputs.freebsd_ports_ref }}"

        run: |
          set -e -x
          echo "pwd: `pwd`"
          tree .

          # A list of ports to check
          ORIGINS=`find * -type d -depth 1`
          echo "ORIGINS: ${ORIGINS}"

          PORTSDIR=/home/runner/work/poudriere/ports/default
          export PORTSDIR
          echo "PORTSDIR=${PORTSDIR}"

          for O in ${ORIGINS}; do
            portlint -abm "${O}"
          done
